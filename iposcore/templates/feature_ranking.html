{% extends 'layout.html' %}
{% block head %}
    <script type="text/javascript" src="javascript/barchart.js"></script>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="row centered"><h2>Feature Ranking</h2></div>
        <div class="row text-center">
            <div class="col-sm-3"><button id="prev" type="button" class="btn btn-secondary" onclick="render(combined[get_next_prev(-1)],properties,false)"><---</button></div>
            <div class="col-sm-3"><button id="displayall" type="button" class="btn btn-secondary">Display all</button></div>
            <div class="col-sm-3"><button type="button" class="btn btn-secondary">Help</button></div>
            <div class="col-sm-3"><button id="next" type="button" class="btn btn-secondary" onclick="render(combined[get_next_prev(1)],properties,false)">---></button></div>
        </div>
    </div>
    <!-- Content -->
    <div class="content-svgs container-fluid"></div>
    <script>
        const graphData = {{data | safe}}

        let all = 0

        const margins = {
            top: 30,
            right: 20,
            bottom: 30,
            left: 60
        }

        const MAX_LABEL_SIZE_Y = 200,
            MAX_LABEL_SIZE_X = 150


        const fullwidth = 1024
        const fullheight = 768

        const width = fullwidth - margins.left - margins.right - MAX_LABEL_SIZE_X
        const height = fullheight - margins.top - margins.bottom - MAX_LABEL_SIZE_Y

        const heightScale = d3.scaleLinear().range([height, 0])

        const widthScale = d3.scaleBand().rangeRound([0, width]).padding(0.3)

        const yAxis = d3.axisLeft(heightScale).tickFormat(d3.format(".0%"))

        const xAxis = d3.axisBottom(widthScale)

        const svg = d3.select('.content-svgs')
            .append('svg')
            .attr('width', fullwidth)
            .attr('height', fullheight)
            .attr('class','centered')

        const properties = {
            width,
            height,
            margins,
            svg,
            widthScale,
            heightScale,
            xAxis,
            yAxis,
        }
        // this is the size of the svg container -- the white part

        const binary = []
        const categorical = []
        const numerical_discrete = []
        const numerical_continuous = []
        const text = []
        const combined = [binary, categorical, numerical_discrete, numerical_continuous]

        for(let x = 0; x< combined.length; ++x)
            for(let y = 0; y< graphData[x][0].length; ++y){
                combined[x].push({
                    column_name : graphData[x][0][y],
                    column_value : graphData[x][1][y]
                })
            }
        let i = 0;

        function get_next_prev(value){
            i = (i + value)%4
            if(i < 0)
                i = 3
            return i
        }
        function renderAll(){
            let container = d3.select('.content-svgs')
            container.selectAll('svg').remove()
            let currRow = container.append('div').attr('class','row');
            properties.width = 500 - properties.margins.left - properties.margins.right - MAX_LABEL_SIZE_X
            properties.height = 500 - properties.margins.top - properties.margins.bottom - MAX_LABEL_SIZE_Y
            properties.heightScale = d3.scaleLinear().range([properties.height, 0])
            properties.widthScale = d3.scaleBand().rangeRound([0, properties.width]).padding(0.3)
            properties.yAxis = d3.axisLeft(properties.heightScale).tickFormat(d3.format(".0%"))
            properties.xAxis = d3.axisBottom(properties.widthScale)
            for(let i = 0; i< combined.length; ++i){
                properties.svg = currRow.append('div').attr('class','col-sm-6').append('svg').attr('width', 500).attr('height', 500).attr('class','centered')
                render(combined[i],properties,true)
            }
            d3.select('#displayall').on('click',()=>renderOne()).text("Hide All")
            d3.select('#prev').attr('disabled','disabled')
            d3.select('#next').attr('disabled','disabled')
        }

        function renderOne(){
            d3.select('.content-svgs').selectAll('svg').remove()
            d3.select('.content-svgs').selectAll('.col-sm-6').remove()
            d3.select('.content-svgs').selectAll('.row').remove()

            properties.width = fullwidth - margins.left - margins.right - MAX_LABEL_SIZE_X
            properties.height = fullheight - margins.top - margins.bottom - MAX_LABEL_SIZE_Y

            properties.heightScale = d3.scaleLinear().range([height, 0])

            properties.widthScale = d3.scaleBand().rangeRound([0, width]).padding(0.3)

            properties.yAxis = d3.axisLeft(heightScale).tickFormat(d3.format(".0%"))

            properties.xAxis = d3.axisBottom(widthScale)

            properties.svg = d3.select('.content-svgs')
                .append('svg')
                .attr('width', fullwidth)
                .attr('height', fullheight)
                .attr('class','centered')

            d3.select('#displayall').on('click',()=>renderAll(properties)).text("Display All")
            d3.select('#prev').attr('disabled',null)
            d3.select('#next').attr('disabled',null)
            render(
                combined[0],
                properties,
                true
            )
        }
        d3.select('#displayall').on('click',()=>renderAll(properties)).text("Display All")
        render(
            combined[0],
            properties,
            true
        )


    </script>
{% endblock %}